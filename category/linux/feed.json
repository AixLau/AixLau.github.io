{
    "version": "https://jsonfeed.org/version/1",
    "title": "陆时忤的博客 • All posts by \"linux\" category",
    "description": "要再见 不要再见",
    "home_page_url": "http://blog.aixcc.top",
    "items": [
        {
            "id": "http://blog.aixcc.top/2024/07/02/%E5%AE%9A%E6%9C%9F%E6%B8%85%E7%90%86Alist%E5%A4%87%E4%BB%BD%E6%96%87%E4%BB%B6/",
            "url": "http://blog.aixcc.top/2024/07/02/%E5%AE%9A%E6%9C%9F%E6%B8%85%E7%90%86Alist%E5%A4%87%E4%BB%BD%E6%96%87%E4%BB%B6/",
            "title": "定期清理Alist备份文件",
            "date_published": "2024-07-02T11:34:29.000Z",
            "content_html": "<h1 id=\"使用-Alist-和-Bash-脚本实现自动化管理\"><a class=\"headerlink\" href=\"#使用-Alist-和-Bash-脚本实现自动化管理\"></a>使用 Alist 和 Bash 脚本实现自动化管理</h1>\n<p>在上次的博客中，我们介绍了如何使用 Alist 来定时备份服务器上的一些文件。本篇博客将介绍如何编写一个 Bash 脚本，定期清理这些备份文件，节省存储空间。</p>\n<h3 id=\"为什么需要定期清理备份文件？\"><a class=\"headerlink\" href=\"#为什么需要定期清理备份文件？\"></a>为什么需要定期清理备份文件？</h3>\n<p>备份文件在系统维护中起着重要作用，但如果不加管理，长期积累的备份文件会占用大量存储空间，甚至可能导致磁盘空间不足的问题。定期清理过期的备份文件，可以有效释放存储资源，确保系统的高效运行。</p>\n<h3 id=\"利用-Alist-提供的接口实现定期清理\"><a class=\"headerlink\" href=\"#利用-Alist-提供的接口实现定期清理\"></a>利用 Alist 提供的接口实现定期清理</h3>\n<p>Alist 提供了 <code>POST /api/fs/list</code> 和 <code>POST /api/fs/remove</code> 接口，分别用于列出文件和删除文件。通过这两个接口，我们可以方便地实现定期清理备份文件的功能。</p>\n<h3 id=\"脚本功能\"><a class=\"headerlink\" href=\"#脚本功能\"></a>脚本功能</h3>\n<p>该 Bash 脚本的主要功能包括：</p>\n<ol>\n<li>列出备份目录中的所有文件。</li>\n<li>判断文件是否超过指定的时间（本文中设置为30天）。</li>\n<li>删除超过指定时间的文件。</li>\n<li>将操作结果记录到日志文件中。</li>\n</ol>\n<h3 id=\"脚本实现\"><a class=\"headerlink\" href=\"#脚本实现\"></a>脚本实现</h3>\n<p>首先，在 <code>/opt/alist</code> 目录下创建脚本文件和日志文件夹：</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token function\">sudo</span> <span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> /opt/alist/log\n<span class=\"token builtin class-name\">cd</span> /opt/alist\n<span class=\"token function\">sudo</span> <span class=\"token function\">vim</span> clean_backups.sh<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n<p>在 <code>clean_backups.sh</code> 文件中输入以下内容：</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token shebang important\">#!/bin/bash</span>\n\n<span class=\"token comment\"># 设置日志文件</span>\n<span class=\"token assign-left variable\">LOG_FILE</span><span class=\"token operator\">=</span><span class=\"token string\">\"/opt/alist/log/clean_back_<span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">date</span> +<span class=\"token string\">'%Y%m%d%H%M%S'</span><span class=\"token variable\">)</span></span>.log\"</span>\n\n<span class=\"token comment\"># 删除超过30天的日志文件</span>\n<span class=\"token function\">find</span> /opt/alist/log <span class=\"token parameter variable\">-type</span> f <span class=\"token parameter variable\">-name</span> <span class=\"token string\">\"*.log\"</span> <span class=\"token parameter variable\">-mtime</span> +30 <span class=\"token parameter variable\">-exec</span> <span class=\"token function\">rm</span> <span class=\"token parameter variable\">-f</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">\\</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\"># 函数：带时间戳的echo</span>\n<span class=\"token function-name function\">log</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"[<span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">date</span> +<span class=\"token string\">'%Y-%m-%d %H:%M:%S'</span><span class=\"token variable\">)</span></span>] <span class=\"token variable\">$1</span>\"</span> <span class=\"token operator\">|</span> <span class=\"token function\">tee</span> <span class=\"token parameter variable\">-a</span> <span class=\"token string\">\"<span class=\"token variable\">$LOG_FILE</span>\"</span>\n<span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token comment\"># 读取token</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token operator\">!</span> <span class=\"token parameter variable\">-f</span> /tmp/alist_token.txt <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\n    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"Token file not found.\"</span>\n    <span class=\"token builtin class-name\">exit</span> <span class=\"token number\">1</span>\n<span class=\"token keyword\">fi</span>\n<span class=\"token assign-left variable\">AUTH_TOKEN</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">cat</span> /tmp/alist_token.txt<span class=\"token variable\">)</span></span>\n\n<span class=\"token comment\"># 检查token是否读取成功</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token parameter variable\">-z</span> <span class=\"token string\">\"<span class=\"token variable\">$AUTH_TOKEN</span>\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\n    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"Token is empty.\"</span>\n    <span class=\"token builtin class-name\">exit</span> <span class=\"token number\">1</span>\n<span class=\"token keyword\">fi</span>\n\n<span class=\"token comment\"># 配置参数</span>\n<span class=\"token assign-left variable\">API_URL</span><span class=\"token operator\">=</span><span class=\"token string\">\"&lt;Alist 地址>\"</span>\n<span class=\"token assign-left variable\">LIST_ENDPOINT</span><span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\">$API_URL</span>/api/fs/list\"</span>\n<span class=\"token assign-left variable\">REMOVE_ENDPOINT</span><span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\">$API_URL</span>/api/fs/remove\"</span>\n<span class=\"token assign-left variable\">BACKUP_PATH</span><span class=\"token operator\">=</span><span class=\"token string\">\"&lt;Alist 存储路径>\"</span>\n\n<span class=\"token comment\"># 当前日期的时间戳（秒）</span>\n<span class=\"token assign-left variable\">CURRENT_DATE</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">date</span> +%s<span class=\"token variable\">)</span></span>\n\n<span class=\"token comment\"># 列出备份目录中的文件</span>\n<span class=\"token assign-left variable\">response</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">curl</span> <span class=\"token parameter variable\">-s</span>  <span class=\"token parameter variable\">-X</span> POST <span class=\"token string\">\"<span class=\"token variable\">$LIST_ENDPOINT</span>\"</span> <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">-H</span> <span class=\"token string\">\"Authorization: <span class=\"token variable\">$AUTH_TOKEN</span>\"</span> <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">-H</span> <span class=\"token string\">\"Content-Type: application/json\"</span> <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">-d</span> <span class=\"token string\">'&#123;\n    \"path\": \"'</span>\"$BACKUP_PATH<span class=\"token string\">\"'\"</span>\n<span class=\"token punctuation\">&#125;</span>'<span class=\"token variable\">)</span></span>\n\n<span class=\"token comment\"># 从response中解析出文件名和创建时间</span>\n<span class=\"token assign-left variable\">files</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"<span class=\"token variable\">$response</span>\"</span> <span class=\"token operator\">|</span> jq <span class=\"token parameter variable\">-r</span> <span class=\"token string\">'.data.content[] | select(.is_dir == false) | \"\\(.name) \\(.created)\"'</span><span class=\"token variable\">)</span></span>\n\n<span class=\"token comment\"># 准备删除的文件列表</span>\n<span class=\"token assign-left variable\">delete_files</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">while</span> <span class=\"token builtin class-name\">read</span> <span class=\"token parameter variable\">-r</span> name created<span class=\"token punctuation\">;</span> <span class=\"token keyword\">do</span>\n  <span class=\"token comment\"># 转换创建日期为时间戳（秒）</span>\n  <span class=\"token assign-left variable\">created_date</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">date</span> <span class=\"token parameter variable\">-d</span> <span class=\"token string\">\"<span class=\"token variable\">$created</span>\"</span> +%s<span class=\"token variable\">)</span></span>\n  \n  <span class=\"token comment\"># 计算文件的年龄 （天）</span>\n  <span class=\"token assign-left variable\">age_days</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$((</span> <span class=\"token punctuation\">(</span>CURRENT_DATE <span class=\"token operator\">-</span> created_date<span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token number\">86400</span> <span class=\"token variable\">))</span></span>\n\n  <span class=\"token comment\"># 输出文件的年龄以供调试</span>\n  log <span class=\"token string\">\"File: <span class=\"token variable\">$name</span>, Created: <span class=\"token variable\">$created</span>, Age (days): <span class=\"token variable\">$age_days</span>\"</span>\n\n  <span class=\"token comment\"># 如果文件超过1天，添加到删除列表</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token variable\">$age_days</span> <span class=\"token parameter variable\">-gt</span> <span class=\"token number\">30</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\n    <span class=\"token assign-left variable\">delete_files</span><span class=\"token operator\">+=</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"<span class=\"token variable\">$name</span>\"</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">fi</span>\n<span class=\"token keyword\">done</span> <span class=\"token operator\">&lt;&lt;&lt;</span> <span class=\"token string\">\"<span class=\"token variable\">$files</span>\"</span>\n\n<span class=\"token comment\"># 输出将要删除的文件列表以供调试</span>\nlog <span class=\"token string\">\"Files to be deleted:\"</span>\n<span class=\"token keyword\">for</span> <span class=\"token for-or-select variable\">file</span> <span class=\"token keyword\">in</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;delete_files<span class=\"token punctuation\">[</span>@<span class=\"token punctuation\">]</span>&#125;</span>\"</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">do</span>\n  log <span class=\"token string\">\"<span class=\"token variable\">$file</span>\"</span>\n<span class=\"token keyword\">done</span>\n\n<span class=\"token comment\"># 删除过期文件</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token variable\">$&#123;<span class=\"token operator\">#</span>delete_files<span class=\"token punctuation\">[</span>@<span class=\"token punctuation\">]</span>&#125;</span> <span class=\"token parameter variable\">-gt</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\n  <span class=\"token keyword\">for</span> <span class=\"token for-or-select variable\">file</span> <span class=\"token keyword\">in</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;delete_files<span class=\"token punctuation\">[</span>@<span class=\"token punctuation\">]</span>&#125;</span>\"</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">do</span>\n    <span class=\"token assign-left variable\">delete_response</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">curl</span> <span class=\"token parameter variable\">-s</span> <span class=\"token parameter variable\">-X</span> POST <span class=\"token string\">\"<span class=\"token variable\">$REMOVE_ENDPOINT</span>\"</span> <span class=\"token punctuation\">\\</span>\n      <span class=\"token parameter variable\">-H</span> <span class=\"token string\">\"Authorization: <span class=\"token variable\">$AUTH_TOKEN</span>\"</span> <span class=\"token punctuation\">\\</span>\n      <span class=\"token parameter variable\">-H</span> <span class=\"token string\">\"Content-Type: application/json\"</span> <span class=\"token punctuation\">\\</span>\n      <span class=\"token parameter variable\">-d</span> <span class=\"token string\">'&#123;\n          \"names\": [\"'</span>\"$file<span class=\"token string\">\"'\"</span><span class=\"token punctuation\">]</span>,\n          <span class=\"token string\">\"dir\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"'\"</span>$BACKUP_PATH<span class=\"token string\">\"'\"</span>\n      <span class=\"token punctuation\">&#125;</span>'<span class=\"token variable\">)</span></span>\n    <span class=\"token assign-left variable\">delete_code</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"<span class=\"token variable\">$delete_response</span>\"</span> <span class=\"token operator\">|</span> jq <span class=\"token parameter variable\">-r</span> <span class=\"token string\">'.code'</span><span class=\"token variable\">)</span></span>\n    <span class=\"token assign-left variable\">delete_message</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"<span class=\"token variable\">$delete_response</span>\"</span> <span class=\"token operator\">|</span> jq <span class=\"token parameter variable\">-r</span> <span class=\"token string\">'.message'</span><span class=\"token variable\">)</span></span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token string\">\"<span class=\"token variable\">$delete_code</span>\"</span> <span class=\"token parameter variable\">-eq</span> <span class=\"token number\">200</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\n      log <span class=\"token string\">\"Successfully deleted <span class=\"token variable\">$file</span>\"</span>\n    <span class=\"token keyword\">else</span>\n      log <span class=\"token string\">\"Failed to delete <span class=\"token variable\">$file</span>: <span class=\"token variable\">$delete_message</span>\"</span>\n    <span class=\"token keyword\">fi</span>\n  <span class=\"token keyword\">done</span>\n<span class=\"token keyword\">else</span>\n  log <span class=\"token string\">\"No files older than 15 day to delete.\"</span>\n<span class=\"token keyword\">fi</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>请将脚本中的 <code>API_URL</code> 和 <code>BACKUP_PATH</code> 替换为你自己的 Alist 地址和存储路径。</p>\n<p>保存并退出编辑器（在 vim 中按 <code>Esc</code>，然后输入 <code>:x</code> 回车保存）。</p>\n<h3 id=\"详细解释\"><a class=\"headerlink\" href=\"#详细解释\"></a>详细解释</h3>\n<ol>\n<li><strong>设置日志文件</strong>：日志文件名为 <code>clean_back_YYYYMMDDHHMMSS.log</code>，存储在 <code>/opt/alist/log</code> 目录中，记录脚本执行过程中的所有重要信息。</li>\n<li><strong>定义 <code>log</code> 函数</strong>：这个函数为日志信息添加时间戳，并将日志信息同时输出到控制台和日志文件中。</li>\n<li><strong>配置 API 参数</strong>：设置 API 的基础 URL、列出文件的端点和删除文件的端点，以及授权令牌和备份路径。</li>\n<li><strong>获取当前时间戳</strong>：使用 <code>date +%s</code> 获取当前时间的 Unix 时间戳（以秒为单位）。</li>\n<li><strong>列出备份目录中的文件</strong>：通过 Alist 提供的 <code>POST /api/fs/list</code> 接口获取备份目录中的文件列表，并使用 <code>jq</code> 提取文件名和创建日期。</li>\n<li><strong>计算文件年龄并判断是否需要删除</strong>：遍历文件列表，计算每个文件的年龄（以天为单位），如果文件超过30天，则将其添加到删除列表中。</li>\n<li><strong>输出将要删除的文件列表</strong>：记录需要删除的文件以供调试。</li>\n<li><strong>删除过期文件</strong>：通过 Alist 提供的 <code>POST /api/fs/remove</code> 接口删除超过30天的文件，并根据响应结果记录删除操作的状态。</li>\n</ol>\n<h3 id=\"运行脚本\"><a class=\"headerlink\" href=\"#运行脚本\"></a>运行脚本</h3>\n<p>将上述脚本保存为 <code>clean_backups.sh</code>，然后给脚本添加执行权限并运行：</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token function\">chmod</span> +x clean_backups.sh\n./clean_backups.sh<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n<h3 id=\"定时任务\"><a class=\"headerlink\" href=\"#定时任务\"></a>定时任务</h3>\n<p>为了让脚本定期运行，可以使用 <code>cron</code> 设置定时任务。例如，每天凌晨 2点运行脚本：</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token function\">sudo</span> <span class=\"token function\">crontab</span> <span class=\"token parameter variable\">-e</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p>在 <code>crontab</code> 编辑器中添加以下行：</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token number\">0</span> <span class=\"token number\">2</span> * * * /opt/alist/clean_backups.sh<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p>保存并退出编辑器（在 vim 中按 <code>Esc</code>，然后输入 <code>:x</code> 回车保存）。</p>\n<p>通过这种方式，您可以自动化清理过期的备份文件，并将操作结果记录到日志文件中，方便日后查看和调试。定期清理备份文件有助于保持系统的整洁，确保服务器的高效运行。</p>\n<hr>\n<p>以上就是使用 Alist 和 Bash 脚本实现自动化清理备份文件的完整方法。希望这篇博客对您有所帮助！如果有任何问题或建议，欢迎在评论区留言讨论。</p>\n",
            "tags": [
                "Alist"
            ]
        }
    ]
}